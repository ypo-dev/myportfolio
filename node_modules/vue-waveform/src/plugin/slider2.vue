<template>
  <div class="container">
    <div ref="slider" class="slider">
      <div class="pace"></div>
      <div ref="handle" class="handle"></div>
    </div>
  </div>
</template>
<script type="text/ecmascript-6">
import bus from './event'
export default {
  created() {
    let _this = this
    this.current = 0
    bus.$on('durationed', function (e) {
      _this.current = 0
      _this.duration = Math.floor(e)
      _this.countdown(Math.floor(e))
    })
    /*bus.$on('updateTimeEnded', function (e) {
      if (_this.duration) {
        let precent = Math.floor(e * 1000) / _this.duration
        if (precent <= 1) {
          _this.handle.style = `left:${precent * 100}%`
        }
      }
    })*/
  },
  destroyed() {
    window.clearTimeout(window.timeid)
  },
  methods: {
    countdown(e) {
      if (window.timeid) {
        window.clearTimeout(window.timeid)
      }
      bus.$emit('updateTimeEnded', this.duration - e)
      let precent = (this.duration - e) / this.duration
      if (precent <= 1) {
        this.handle.style = `left:${precent * this.slider.clientWidth - 13}px`
      }
      window.timeid = setTimeout(() => {
        if (e - 50 >= 0) {
          this.countdown(e - 50)
        }
      }, 50)
    },
    seekto(current) {
      this.countdown(this.duration - current)
    }
  },
  mounted() {
    let slider = this.$refs.slider
    let handle = this.$refs.handle
    this.slider = slider
    this.handle = handle
    this.infos = {
      ismove: false,
      delX: slider.getBoundingClientRect().left,
      minX: 0,
      maxX: slider.clientWidth - handle.clientWidth / 2
    }
    handle.addEventListener('mousedown', (e) => {
      this.infos.ismove = true
    })
    slider.addEventListener('click', (e) => {
      if (this.duration && this.duration > 0) {
        let left = e.pageX - this.infos.delX
        let precent = left / (this.slider.clientWidth - 13)
        let current = this.duration * precent
        this.countdown(this.duration - current)
        /* handle.style.left = `${left}px` */
        bus.$emit('seekTimed', current)
      }
    })
    document.addEventListener('mouseup', (e) => {
      this.infos.ismove = false
    })
    document.addEventListener('mousemove', (e) => {
      if (!this.infos.ismove) {
        return
      }
      let left = e.clientX - this.infos.delX
      if (left < this.infos.minX || left > this.infos.maxX) return
      handle.style.left = `${left}px`
    })
  }
}
</script>
<style scoped lang="stylus" rel="stylesheet/stylus">
.container
  .position relative
  .slider
    background-color: #282a31
    height: 13px
    width: 100%
    position: relative
    cursor: pointer
    border-radius: 25px
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.5) inset
    .pace
      position: absolute;
      background: #258fb8;
      height: 100%;
      opacity: 0.7;
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;
      -o-border-radius: 5px;
      -ms-border-radius: 5px;
      -khtml-border-radius: 5px;
      border-radius: 5px;
    .handle
      background: url(./btn.png)
      margin-left: -5px;
      margin-top: -8px;
      position: absolute;
      opacity: 1;
      width: 26px;
      height: 26px;
      -moz-border-radius: 50%;
      -webkit-border-radius: 50%;
      -o-border-radius: 50%;
      -ms-border-radius: 50%;
      -khtml-border-radius: 50%;
      border-radius: 50%;
      -moz-transition: opacity 0.3s;
      -webkit-transition: opacity 0.3s;
      -o-transition: opacity 0.3s;
      transition: opacity 0.3s;
</style>