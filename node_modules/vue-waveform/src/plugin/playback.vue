<template>
  <div v-bind:style="{width: WIDTH + 'px',height: HEIGHT + 'px'}">
    <div v-bind:style="{width: WIDTH + 'px',height: HEIGHT + 'px'}">
      <canvas ref="canvas" style="background: #0a1940;"  id="canvas"  :width="WIDTH" :height="HEIGHT - 13" ></canvas>
      <slider ref="slider"></slider>
    </div>
<!--     <div class="currenttime">
  <span>{{currentTime  ? currentTime : '00'}}/{{duration ? duration : '00:00:00'}}</span>
</div> -->
  </div>
</template>
<script type="text/ecmascript-6">
import bus from './event'
import Drawer from './drawer.js'
import WsPlayer from './websocket.js'
import Mse from './mse.js'
import slider from './slider3'
export default {
  name: '',
  data() {
    return {
      duration: 0,
      currentTime: 0
    }
  },
  created() {
    let _this = this
    bus.$on('durationed', function (e) {
      _this.duration = _this.formatDuring(e)
      _this.$emit('durationEnded', _this.duration)
    })
    bus.$on('updateTimeEnded', function (e) {
      _this.$emit('updateTimeEnded', e)
      _this.currentTime = _this.formatDuring(e)
    })
    bus.$on('seekTimed', function (e) {
      // _this.mse.dom.currentTime = e
      // _this.mse.restartDom()
      _this.wsPlayer.seek(Math.floor(e))
      // _this.mse.play()
    })
  },
  mounted() {
    this.init()
  },
  components: {
    slider
  },
  props: {
    range: {
      type: Number,
      default: 1
    },
    type: {
      type: String,
      default: 'bar'
    },
    WIDTH: {
      default: 500
    },
    HEIGHT: {
      type: Number,
      default: 300
    },
    arraybuffer: {
      type: ArrayBuffer
    },
    bgColor: {
      type: String,
      default: 'rgb(0, 0, 0)'
    },
    websocketURL: {
      type: String
    },
    id: {
      type: Number
    },
    fftSize: {
      type: Number,
      default: 256
    }
  },
  watch: {
    currentTime(vnew, old) {
      if (vnew === old) return
      this.$emit('currentTimeEnded', vnew)
    },
    arraybuffer(vnew, old) {
      if (typeof vnew === 'object') {
        this.drawer.receive(vnew)
      }
    },
    type(vnew, old) {
      if (vnew !== old) {
        this.drawer.receive = this.drawer.warpperReceive(vnew)
      }
    },
    WIDTH(vnew, old) {
      if (vnew !== old) {
        this.drawer.setWidth(vnew)
      }
    }
  },
  destroyed() {
    this.wsPlayer && this.wsPlayer.stop()
  },
  methods: {
    seekTo(timestamp) {
      this.wsPlayer.seek(timestamp)
      this.$refs.slider.seekto(timestamp)
    },
    formatDuring: function(mss) {
      let hours = parseInt((mss % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
      let minutes = parseInt((mss % (1000 * 60 * 60)) / (1000 * 60))
      let seconds = (mss % (1000 * 60)) / 1000
      seconds = Math.floor(seconds)
      if (minutes <= 9) {
        minutes = `0${minutes}`
      }
      if (hours <= 9) {
        hours = `0${hours}`
      }
      if (seconds <= 9) {
        seconds = `0${seconds}`
      }
      return hours + ':' + minutes + ':' + seconds
    },
    openWS() {
      return new Promise((resolve, reject) => {
        this.$nextTick(() => {
          this.wsPlayer.openWs(this.websocketURL, this.id).then(() => {
            resolve()
          })
        })
      })
    },
    play() {
      this.wsPlayer.play()
    },
    pause() {
      this.wsPlayer.pause()
    },
    stop() {
      return this.wsPlayer.stop()
    },
    init() {
      let canvasCtx = this.$refs.canvas.getContext('2d')
      let {WIDTH, HEIGHT, range, fftSize, type, bgColor} = this
      this.drawer = new Drawer({
        canvasCtx,
        WIDTH,
        HEIGHT: HEIGHT - 13,
        range,
        fftSize,
        type,
        bgColor
      })
      let mse = new Mse()
      this.mse = mse
      this.wsPlayer = new WsPlayer({
        Mse: mse,
        Drawer: this.drawer
      })
    }
  }
}
</script>
<style scoped lang="stylus" rel="stylesheet/stylus">

</style>