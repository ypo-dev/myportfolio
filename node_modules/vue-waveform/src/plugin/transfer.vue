<template>
  <div class="wrapper">
    <div class="item decibel borderr">
      <canvas v-bind:style="{background: bgColor}" ref="decibelL" width="30" :height="HEIGHT"></canvas>
    </div>
    <div class="item decibel">
      <canvas v-bind:style="{background: bgColor}" ref="decibelR" width="30" :height="HEIGHT"></canvas>
    </div>
    <div class="item">
      <canvas v-bind:style="{background: bgColor}" ref="canvas" id="canvas" :width="WIDTH - 60" :height="HEIGHT"></canvas>
    </div>
  </div>
</template>
<script type="text/ecmascript-6">
import Drawer from './drawer.js'
import WsPlayer from './websocket.js'
import Mse from './mse.js'
export default {
  name: '',
  mounted() {
    this.init()
  },
  props: {
    range: {
      type: Number,
      default: 1
    },
    type: {
      type: String,
      default: 'bar'
    },
    WIDTH: {
      default: 500
    },
    HEIGHT: {
      type: Number,
      default: 300
    },
    arraybuffer: {
      type: ArrayBuffer
    },
    bgColor: {
      type: String,
      default: 'rgb(0, 0, 0)'
    },
    websocketURL: {
      type: String
    },
    id: {
      type: Number
    },
    fftSize: {
      type: Number,
      default: 256
    }
  },
  watch: {
    arraybuffer(vnew, old) {
      if (typeof vnew === 'object') {
        this.drawer.receive(vnew)
      }
    },
    type(vnew, old) {
      if (vnew !== old) {
        this.drawer.receive = this.drawer.warpperReceive(vnew)
      }
    },
    WIDTH(vnew, old) {
      if (vnew !== old) {
        this.drawer.setWidth(vnew)
      }
    }
  },
  destroyed() {
    this.wsPlayer && this.wsPlayer.stop()
    this.wsPlayer = null
  },
  methods: {
    openWS() {
      return new Promise((resolve, reject) => {
        this.$nextTick(() => {
          this.wsPlayer.openWs(this.websocketURL, this.id).then(() => {
            resolve()
          })
        })
      })
    },
    play() {
      this.wsPlayer.play()
    },
    pause() {
      this.wsPlayer.pause()
    },
    stop() {
      return this.wsPlayer.stop()
    },
    init() {
      let canvasCtx = this.$refs.canvas.getContext('2d')
      let decibelL = this.$refs.decibelL.getContext('2d')
      let decibelR = this.$refs.decibelR.getContext('2d')
      let {WIDTH, HEIGHT, range, fftSize, type, bgColor} = this
      this.drawer = new Drawer({
        canvasCtx,
        WIDTH,
        HEIGHT,
        range,
        fftSize,
        type,
        bgColor
      })
      this.wsPlayer = new WsPlayer({
        Mse: new Mse(),
        canvasCtxL: decibelL,
        canvasCtxR: decibelR,
        WIDTH,
        HEIGHT,
        bgColor: '#070957',
        Drawer: this.drawer
      })
    }
  }
}
</script>
<style scoped lang="stylus" rel="stylesheet/stylus">
.wrapper
  overflow hidden
  .borderr
    border-right 1px solid red
  .item
    float left
    vertical-align bottom
    canvas
      vertical-align bottom
</style>